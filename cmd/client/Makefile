# Makefile for clauded client
SHELL=/bin/bash

# å˜é‡å®šä¹‰
BINARY_NAME=clauded
VERSION=$(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME=$(shell date -u '+%Y-%m-%d_%H:%M:%S')
GIT_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Go ç›¸å…³å˜é‡
GO=go
GOOS?=$(shell go env GOOS)
GOARCH?=$(shell go env GOARCH)
CGO_ENABLED?=0

# ç¼–è¯‘å‚æ•°
LDFLAGS=-ldflags "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT} -s -w"

# è¾“å‡ºç›®å½•
OUTPUT_DIR=output

# æ”¯æŒçš„å¹³å°
PLATFORMS=linux/amd64 linux/arm64 darwin/amd64 darwin/arm64

# é»˜è®¤ç›®æ ‡
.PHONY: all
all: build

# æ„å»ºå½“å‰å¹³å°
.PHONY: build
build:
	@echo "ğŸ”¨ æ„å»º ${BINARY_NAME} for ${GOOS}/${GOARCH}..."
	@mkdir -p ${OUTPUT_DIR}
	CGO_ENABLED=${CGO_ENABLED} ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-${GOOS}-${GOARCH} ./main.go
	@echo "âœ… æ„å»ºå®Œæˆ: ${OUTPUT_DIR}/${BINARY_NAME}-${GOOS}-${GOARCH}"

# æ„å»ºæ‰€æœ‰å¹³å°
.PHONY: build-all
build-all:
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰å¹³å°çš„ ${BINARY_NAME}..."
	@mkdir -p ${OUTPUT_DIR}
	@for platform in ${PLATFORMS}; do \
		IFS='/' read -r os arch <<< "$$platform"; \
		echo "  ğŸ“¦ æ„å»º $$os/$$arch..."; \
		GOOS=$$os GOARCH=$$arch CGO_ENABLED=0 ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-$$os-$$arch ./main.go; \
	done
	@echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ"
	@ls -lh ${OUTPUT_DIR}

# æ¸…ç†è¾“å‡ºç›®å½•
.PHONY: clean
clean:
	@echo "ğŸ§¹ æ¸…ç†è¾“å‡ºç›®å½•..."
	@rm -rf ${OUTPUT_DIR}
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
.PHONY: info
info:
	@echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
	@echo "  äºŒè¿›åˆ¶åç§°: ${BINARY_NAME}"
	@echo "  ç‰ˆæœ¬: ${VERSION}"
	@echo "  æ„å»ºæ—¶é—´: ${BUILD_TIME}"
	@echo "  Git æäº¤: ${GIT_COMMIT}"
	@echo "  Go ç‰ˆæœ¬: $$(go version)"
	@echo "  å½“å‰å¹³å°: ${GOOS}/${GOARCH}"

# å¸®åŠ©
.PHONY: help
help:
	@echo "ğŸ“– å¯ç”¨çš„ Make ç›®æ ‡:"
	@echo ""
	@echo "  make build         - æ„å»ºå½“å‰å¹³å°ç‰ˆæœ¬"
	@echo "  make build-all     - æ„å»ºæ‰€æœ‰æ”¯æŒå¹³å°ç‰ˆæœ¬"
	@echo "  make clean         - æ¸…ç†è¾“å‡ºç›®å½•"
	@echo "  make info          - æ˜¾ç¤ºæ„å»ºä¿¡æ¯"