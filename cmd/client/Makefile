# Makefile for gotty-piko-client
SHELL=/bin/bash
# æ”¯æŒ macOS å’Œ Linux å¹³å°ç¼–è¯‘

# å˜é‡å®šä¹‰
BINARY_NAME=clauded
VERSION=$(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME=$(shell date -u '+%Y-%m-%d_%H:%M:%S')
GIT_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Go ç›¸å…³å˜é‡
GO=go
GOOS?=$(shell go env GOOS)
GOARCH?=$(shell go env GOARCH)
CGO_ENABLED?=0

# ç¼–è¯‘å‚æ•°
LDFLAGS=-ldflags "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT} -s -w"

# è¾“å‡ºç›®å½•
OUTPUT_DIR=output

# æ”¯æŒçš„å¹³å° (ä»… macOS å’Œ Linux)
PLATFORMS=linux/amd64 linux/arm64 darwin/amd64 darwin/arm64

# é»˜è®¤ç›®æ ‡
.PHONY: all
all: build

# æ„å»ºå½“å‰å¹³å°
.PHONY: build
build:
	@echo "ğŸ”¨ æ„å»º ${BINARY_NAME} for ${GOOS}/${GOARCH}..."
	@mkdir -p ${OUTPUT_DIR}
	CGO_ENABLED=${CGO_ENABLED} ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME} ./main.go
	@echo "âœ… æ„å»ºå®Œæˆ: ${OUTPUT_DIR}/${BINARY_NAME}"

# æ¸…ç†è¾“å‡ºç›®å½•
.PHONY: clean
clean:
	@echo "ğŸ§¹ æ¸…ç†è¾“å‡ºç›®å½•..."
	@rm -rf ${OUTPUT_DIR}
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ„å»ºæ‰€æœ‰å¹³å°å¹¶æ‰“åŒ…
.PHONY: build-all
build-all:
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰å¹³å°çš„ ${BINARY_NAME} (ä»… macOS å’Œ Linux)..."
	@mkdir -p ${OUTPUT_DIR}
	@for platform in ${PLATFORMS}; do \
		IFS='/' read -r os arch <<< "$$platform"; \
		echo "  ğŸ“¦ æ„å»º $$os/$$arch..."; \
		GOOS=$$os GOARCH=$$arch CGO_ENABLED=0 ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-$$os-$$arch ./main.go; \
	done
	@echo ""
	@echo "ğŸ“¦ æ‰“åŒ…æ‰€æœ‰å¹³å°..."
	@for platform in ${PLATFORMS}; do \
		IFS='/' read -r os arch <<< "$$platform"; \
		binary_name="${BINARY_NAME}-$$os-$$arch"; \
		archive_name="${BINARY_NAME}-${VERSION}-$$os-$$arch.tar.gz"; \
		echo "  ğŸ“¦ æ‰“åŒ… $$archive_name..."; \
		tar -czf ${OUTPUT_DIR}/$$archive_name -C ${OUTPUT_DIR} $$binary_name; \
	done
	@echo ""
	@echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºå¹¶æ‰“åŒ…å®Œæˆ"
	@echo "ğŸ“ è¾“å‡ºç›®å½•: ${OUTPUT_DIR}/"
	@ls -lh ${OUTPUT_DIR}/*.tar.gz 2>/dev/null || echo "  (æ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…æ–‡ä»¶)"

# ä»…æ‰“åŒ…å·²æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶
.PHONY: package
package:
	@echo "ğŸ“¦ æ‰“åŒ…å·²æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶..."
	@if [ ! -d "${OUTPUT_DIR}" ]; then \
		echo "âŒ é”™è¯¯: ${OUTPUT_DIR} ç›®å½•ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ make build-all"; \
		exit 1; \
	fi
	@for platform in ${PLATFORMS}; do \
		IFS='/' read -r os arch <<< "$$platform"; \
		binary_name="${BINARY_NAME}-$$os-$$arch"; \
		if [ -f "${OUTPUT_DIR}/$$binary_name" ]; then \
			archive_name="${BINARY_NAME}-${VERSION}-$$os-$$arch.tar.gz"; \
			echo "  ğŸ“¦ æ‰“åŒ… $$archive_name..."; \
			tar -czf ${OUTPUT_DIR}/$$archive_name -C ${OUTPUT_DIR} $$binary_name; \
		fi \
	done
	@echo ""
	@echo "âœ… æ‰“åŒ…å®Œæˆ"
	@ls -lh ${OUTPUT_DIR}/*.tar.gz 2>/dev/null || echo "  (æ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…æ–‡ä»¶)"

# æ„å»ºç‰¹å®šå¹³å°
.PHONY: build-linux
build-linux:
	@echo "ğŸ”¨ æ„å»º Linux ç‰ˆæœ¬..."
	@mkdir -p ${OUTPUT_DIR}
	GOOS=linux GOARCH=amd64 CGO_ENABLED=0 ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-linux-amd64 ./main.go
	GOOS=linux GOARCH=arm64 CGO_ENABLED=0 ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-linux-arm64 ./main.go
	@echo "âœ… Linux ç‰ˆæœ¬æ„å»ºå®Œæˆ"

.PHONY: build-darwin
build-darwin:
	@echo "ğŸ”¨ æ„å»º macOS ç‰ˆæœ¬..."
	@mkdir -p ${OUTPUT_DIR}
	GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-darwin-amd64 ./main.go
	GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 ${GO} build ${LDFLAGS} -o ${OUTPUT_DIR}/${BINARY_NAME}-darwin-arm64 ./main.go
	@echo "âœ… macOS ç‰ˆæœ¬æ„å»ºå®Œæˆ"

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
.PHONY: info
info:
	@echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
	@echo "  äºŒè¿›åˆ¶åç§°: ${BINARY_NAME}"
	@echo "  ç‰ˆæœ¬: ${VERSION}"
	@echo "  æ„å»ºæ—¶é—´: ${BUILD_TIME}"
	@echo "  Git æäº¤: ${GIT_COMMIT}"
	@echo "  Go ç‰ˆæœ¬: $$(go version)"
	@echo "  å½“å‰å¹³å°: ${GOOS}/${GOARCH}"
	@echo ""
	@echo "ğŸ“¦ æ”¯æŒçš„å¹³å°:"
	@for platform in ${PLATFORMS}; do \
		echo "  - $$platform"; \
	done

# å¸®åŠ©
.PHONY: help
help:
	@echo "ğŸ“– å¯ç”¨çš„ Make ç›®æ ‡:"
	@echo ""
	@echo "æ„å»ºç›¸å…³:"
	@echo "  make build         - æ„å»ºå½“å‰å¹³å°ç‰ˆæœ¬"
	@echo "  make build-all     - æ„å»ºæ‰€æœ‰æ”¯æŒå¹³å°ç‰ˆæœ¬å¹¶æ‰“åŒ… (æ¨è)"
	@echo "  make build-linux   - ä»…æ„å»º Linux ç‰ˆæœ¬ (amd64, arm64)"
	@echo "  make build-darwin  - ä»…æ„å»º macOS ç‰ˆæœ¬ (amd64, arm64)"
	@echo ""
	@echo "æ‰“åŒ…ç›¸å…³:"
	@echo "  make package       - æ‰“åŒ…å·²æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸º tar.gz"
	@echo ""
	@echo "å…¶ä»–:"
	@echo "  make clean         - æ¸…ç†è¾“å‡ºç›®å½•"
	@echo "  make info          - æ˜¾ç¤ºæ„å»ºä¿¡æ¯"
	@echo "  make help          - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "ğŸ“¦ æ”¯æŒçš„å¹³å°:"
	@echo "  - Linux (amd64, arm64)"
	@echo "  - macOS (amd64, arm64)"
	@echo ""
	@echo "ğŸ’¡ ç¤ºä¾‹:"
	@echo "  make build-all    # æ„å»ºæ‰€æœ‰å¹³å°å¹¶æ‰“åŒ…"
	@echo "  make clean && make build-all  # æ¸…ç†åé‡æ–°æ„å»º"
	@echo ""
	@echo "ğŸ“ è¾“å‡ºç›®å½•: ${OUTPUT_DIR}/"
	@echo "  - äºŒè¿›åˆ¶æ–‡ä»¶: clauded-{os}-{arch}"
	@echo "  - æ‰“åŒ…æ–‡ä»¶: clauded-{version}-{os}-{arch}.tar.gz" 